<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>Analysis Result</title>
  <link rel="icon" href="{{ url_for('static', filename='logo/favicon.ico') }}">
  <link rel="apple-touch-icon" sizes="180x180" href="{{ url_for('static', filename='logo/site_logo_128.png') }}">
  <meta name="theme-color" content="#0ea5a4">
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600;700&display=swap" rel="stylesheet">
  <style>
    body{font-family:Poppins,Arial,Helvetica,sans-serif;background:#f6fbfb;color:#0f172a;padding:24px}
    .card{background:white;border-radius:12px;padding:20px;max-width:1100px;margin:20px auto;box-shadow:0 10px 30px rgba(2,6,23,0.06)}
    .row{display:flex;gap:18px;align-items:flex-start}
    .thumb{width:360px;height:200px;border-radius:8px;overflow:hidden;border:1px solid #e6eef2}
    .meta{flex:1}
    .meta h2{margin:0 0 8px}
    .meta p{color:#64748b;margin:6px 0}
    .metrics{display:grid;grid-template-columns:repeat(auto-fit,minmax(160px,1fr));gap:12px;margin-top:16px}
    .metric{background:linear-gradient(90deg,#0ea5a4,#6366f1);color:white;padding:12px;border-radius:8px}
    .actions{margin-top:18px;display:flex;gap:10px}
    .btn{padding:10px 14px;border-radius:8px;border:none;cursor:pointer}
    .btn-primary{background:linear-gradient(90deg,#0ea5a4,#0b7285);color:white}
    .btn-ghost{background:white;border:1px solid #e6eef2}
  </style>
</head>
<body>
  <div class="card">
    <div id="content">
      <div class="row">
        <div class="thumb">
          <img id="resultThumb" src="" alt="thumbnail" style="width:100%;height:100%;object-fit:cover"/>
        </div>
        <div class="meta">
          <h2 id="title">Analysis</h2>
          <p id="status">Status: —</p>
          <p id="info">File: —</p>

          <div class="actions">
            <button class="btn btn-primary" id="downloadJson">Download JSON</button>
            <button class="btn btn-ghost" id="downloadCsv">Download CSV</button>
            <button class="btn btn-ghost" id="backBtn">Back to Dashboard</button>
          </div>
        </div>
      </div>

      <div class="metrics" id="metrics"></div>

      <pre id="raw" style="margin-top:18px;background:#0f172a;color:#e6eef2;padding:12px;border-radius:8px;display:none;white-space:pre-wrap"></pre>
    </div>
  </div>

  <script>
    const id = location.pathname.split('/').pop();
    const apiUrl = `/results/${id}`;

    async function load() {
      try {
        const res = await fetch(apiUrl);
        const data = await res.json();
        document.getElementById('title').textContent = `Analysis ${data.id}`;
        document.getElementById('status').textContent = `Status: ${data.status}`;
        document.getElementById('info').textContent = `File: ${data.filename} • Type: ${data.file_type}`;

        const thumb = document.getElementById('resultThumb');
        thumb.src = `/api/thumbnail/${data.id}`;
        thumb.onerror = () => { thumb.src = '/static/logo/site_logo.svg'; };

        const metrics = document.getElementById('metrics');
        metrics.innerHTML = '';
        const results = data.results || {};
        // Create simple metric cards for primitive keys
        Object.keys(results).forEach(k => {
          const v = results[k];
          if (typeof v === 'string' || typeof v === 'number' || typeof v === 'boolean') {
            const el = document.createElement('div');
            el.className = 'metric';
            el.innerHTML = `<div style="font-weight:700">${String(v)}</div><div style="font-size:12px;opacity:0.9;margin-top:6px">${k}</div>`;
            metrics.appendChild(el);
          }
        });

        // Raw results viewer
        const raw = document.getElementById('raw');
        raw.style.display = 'block';
        raw.textContent = JSON.stringify(results, null, 2);

        // Wire actions
        document.getElementById('downloadJson').onclick = () => window.open(`/results/${data.id}/download/json`, '_blank');
        document.getElementById('downloadCsv').onclick = () => window.open(`/results/${data.id}/download/csv`, '_blank');
        document.getElementById('backBtn').onclick = () => window.location.href = '/';

      } catch (err) {
        document.getElementById('title').textContent = 'Failed to load result';
        document.getElementById('status').textContent = err.message;
      }
    }

    load();
  </script>
</body>
</html>
